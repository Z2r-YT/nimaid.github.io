<!--
    ┌┬┐┬  ┬┌┐┌┬┌┬┐┌─┐┬┌┬┐ ┌─┐┌─┐┌┬┐
     │ └┐┌┘│││││││├─┤│ ││ │  │ ││││
     ┴  └┘o┘└┘┴┴ ┴┴ ┴┴─┴┘o└─┘└─┘┴ ┴
    
    Okay look, I am not a fucking web developer.
    I am a Python prankster if anything.
    I am fucking amazed I even got this put together.
    
    Check out the developer console to see the video ID's and your current playlist.
    -->
<!DOCTYPE html>
<html>
    <head>
        <title>Interdimensional Cable Box</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script type="text/javascript">
            var buffer_check_delay = 5000; // How long to wait after buffering
            var start_buffer_check_delay = 2000; // How long to wait after start
            
            var databases = {};
            databases["interdimensional"] = "interdimensional_database.json"
            databases["test"] = "test_database.json"
            databases["default"] = databases["interdimensional"]
            
            var GET = {};
            var query = window.location.search.substring(1).split("&");
            for (var i = 0, max = query.length; i < max; i++)
            {
                if (query[i] === "") // check for trailing & with no param
                    continue;

                var param = query[i].split("=");
                GET[decodeURIComponent(param[0])] = decodeURIComponent(param[1] || "");
            }
            
            var database_input = GET["database"];
            
            var db_file = "";
            if (Object.keys(databases).includes(database_input))
            {
                console.log("Using database: ".concat(database_input));
                db_file = databases[database_input]; 
            }
            else
            {
                if (database_input != undefined)
                {
                    console.log("Invalid database name! Using 'default'");
                }
                else
                {
                    console.log("Using 'default' database.");
                }
                db_file = databases["default"];
            }
            console.log("Database file: ".concat(db_file));
            
            var static_mp4 = "";
            var intro_id = "";
            var IVCdump = [];
            // To update the database, run "python3 IVCdump.py" in the same directory as this file.
            $.getJSON(db_file, function(json) 
            {
                static_mp4 = json.static_mp4;
                if (static_mp4 != undefined)
                {
                    console.log("Logging static MP4 filename...");
                    console.log(static_mp4);
                }
                else
                {
                    console.log("No MP4 video for static was provided for database.");
                }
                
                intro_id = json.intro_video;
                console.log("Logging intro ID...");
                console.log(intro_id);
                
                IVCdump = json.videos;
                shuffle(IVCdump);
                console.log("Logging playlist...");
                console.log(IVCdump);
            });
        </script>
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <style>
            .videoContainer {
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            #bg_video {
                position: absolute;
                width: 100%;
                height: 100%;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                filter:opacity(50%);
            }
            #overlay {
                color: white;
                background-color: black;
                opacity :0.5;
                font-family: Courier New;
                font-size: 24px;
                display: inline-block;
                padding-top: 0px;
                padding-bottom: 0px;
                padding-left: 6px;
                padding-right: 6px;
            }
            #overlay_logo_container {
                width: 100%;
                position: fixed;
                text-align: center;
                top: 0px;
            }
            player {
                /* optional */
                width: 100%;
                height: 100%; 
            }
            #overlay_message_container {
                width: 100%;
                position: fixed;
                text-align: center;
                bottom: 0px;
            }
        </style>
    </head>
    <body style="background-image:url(static.gif);background-size:1000px;">
        <video autoplay muted loop id="bg_video">
            <source type="video/mp4" id="bg_video_source">
        </video>
        <script>
            var video_main = document.getElementById("bg_video");
            var video_source = document.getElementById("bg_video_source");
            if ((static_mp4 != undefined) && !(static_mp4 === ""))
            {
                console.log("Using static MP4...");
                video_source.setAttribute("src", static_mp4);
                
                video_main.load();
                video_main.play();
            }
            else
            {
                console.log("NO static MP4...");
                static_mp4 = undefined;
                video_main.remove();
            }
        </script>
        <audio id="noise" src="noise.mp3" preload="auto" loop="loop"></audio>
        <div id="player" class="videoContainer"></div>
        <div id="overlay_logo_container">
            <div id="overlay">
                <b>tv.nimaid.com</b>
            </div>
        </div>
        <div id="overlay_message_container">
            <div id="overlay">
                Please wait while we connect to the multiverse...
            </div>
        </div>
        <script>      
            function shuffle(a) {
                var j, x, i;
                for (i = a.length - 1; i > 0; i--) {
                    j = Math.floor(Math.random() * (i + 1));
                    x = a[i];
                   a[i] = a[j];
                   a[j] = x;
                }
                return a;
            }
            
            var curr_vid_index = 0;
            var is_first = true;
            var cc_toggle = false;
            
            function update_index() {
                if (!is_first) {
                    this.curr_vid_index++;
                    if (curr_vid_index >= IVCdump.length) {
                        console.log("Reached end of playlist, shuffling...");
                        shuffle(IVCdump);
                        console.log("Shuffled. Logging new playlist...");
                        console.log(IVCdump);
                
                        curr_vid_index = 0;
                    }
                console.log("Just changed index to: " + curr_vid_index);
                }
                else {
                is_first = false;
                }
            }
            
            function set_message(mess) {
                document.getElementById("overlay_message_container").innerHTML = "<div id='overlay'>" + mess + "</div>";
            }
            
            var noise = document.getElementById("noise");
                function play_noise() {
                noise.play();
            }
            function stop_noise() {
                noise.pause();
                noise.currentTime = 0;
            }
            
            window.onload = function() {
                play_noise();
            }
            
            var tag = document.createElement('script');
            
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            
            var player;
            function onYouTubeIframeAPIReady() {
                player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: intro_id, //the intro video
                    playerVars: {
                        wmode:'opaque',
                        autohide: 1,
                        vq:'highres',
                        modestbranding:1,
                        autoplay:1,
                        controls:0,
                        fs:0,
                        rel:0,
                        showinfo:0,
                        disablekb:1,
                        iv_load_policy:3,
                        enablejsapi:1
                    },
                    events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError' : onPlayerError
                    }
                });
            }
            
            var buffering = false;  
            function check_buffer_skip() {
                console.log("Checking if buffering still...");
                if (buffering) {
                    console.log("Still buffering! Re-starting video now...");
                    set_message("Video looks stuck! Try clicking to start!");
                    //player.stopVideo();
                    player.playVideo();
                }
                else {
                    console.log("Video looks like it's done buffering.");
                }
            }
            
            function onPlayerReady(event) {
                event.target.playVideo();  // https://goo.gl/xX8pDD says I cant do this...
                buffering = true;
                console.log("Player changed to BUFFERING state!");
                set_message("Aquiring signal...");
                setTimeout(check_buffer_skip, start_buffer_check_delay); // Sorry google! Users want this! It's literally the only thing my site does.
                stop_noise();
            }
            
            function onPlayerStateChange(event) {
                if (event.data == YT.PlayerState.PAUSED) {
                    buffering = false;
                    console.log("Player changed to PAUSED state!");
                    set_message("Re-tuning...");
                    update_index();
                    console.log("Index is now: " + curr_vid_index);
                    var vid_id = new String(IVCdump[curr_vid_index]);
                    console.log("ID is now: " + vid_id);
                    player.loadVideoById(vid_id);
                    player.playVideo();
                    window.focus();
                }
                else if (event.data == YT.PlayerState.ENDED) {
                    buffering = false;
                    console.log("Player changed to ENDED state!");
                    set_message("Signal lost! Re-tuning...");
                    update_index();
                    console.log("Index is now: " + curr_vid_index);
                    var vid_id = new String(IVCdump[curr_vid_index]);
                    console.log("ID is now: " + vid_id);
                    player.loadVideoById(vid_id);
                    player.playVideo();
                }
                else if (event.data == YT.PlayerState.BUFFERING) {
                    buffering = true;
                    console.log("Player changed to BUFFERING state!");
                    set_message("Aquiring signal...");
                    document.getElementById("player").style.opacity = "0";
                    document.getElementById("bg_video").style.filter = "opacity(50%)";
                    play_noise();
                    setTimeout(check_buffer_skip, buffer_check_delay);
                }
                else if (event.data == YT.PlayerState.PLAYING) {
                    buffering = false;
                    console.log("Player changed to PLAYING state!");
                    var vid_id = player.getVideoData()['video_id'];
                    if (is_first) {
                        set_message("Welcome! Please click or use the spacebar to re-tune the channel.");
                        document.getElementById("player").style.filter = "opacity(50%)";
                        document.getElementById("bg_video").style.filter = "opacity(0%)";
                    }
                    else {
                        document.getElementById("player").style.filter = "opacity(100%)";
                        set_message("Now playing channel: " + vid_id);
                    }
                    stop_noise();
                    document.getElementById("player").style.opacity = "1";
                }
            }
            
            function onPlayerError(event) {
                buffering = false;
                console.log("Player changed to ERROR state!");
                set_message("Signal is corrupt! Re-tuning...");
                update_index();
                console.log("Index is now: " + curr_vid_index);
                var vid_id = new String(IVCdump[curr_vid_index]);
                console.log("ID is now: " + vid_id);
                player.loadVideoById(vid_id);
                player.playVideo();
            }
              
            document.body.onkeydown = function(e){
                //cconsole.log(e.keyCode);
                if(e.keyCode == 32) {
                    player.pauseVideo();
                }
                else if (e.keyCode == 67) {
                    player.setOption("captions", "track", {"languageCode": "es"});  //Works for html5 ignored by AS3
                    player.setOption("cc", "track", {"languageCode": "es"});  //Works for AS3 ignored by html5
                    if (cc_toggle) {
                        player.unloadModule("captions");  //Works for html5 ignored by AS3
                        player.unloadModule("cc");  //Works for AS3 ignored by html5
                        console.log("Closed Captions OFF!");
                        cc_toggle = false;
                    }
                    else {
                        player.loadModule("captions");  //Works for html5 ignored by AS3
                        player.loadModule("cc");  //Works for AS3 ignored by html5
                        console.log("Closed Captions ON!");
                        cc_toggle = true;
                    }
                }
            }
        </script>
    </body>
</html>
